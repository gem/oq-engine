#
#

"""
    09/03/2020:
        Japanese attenuation model is not fully implemented yet (needs calculation of arc-crossing flag)
        Epistemic uncertainty model is not implemented
        Giving magnitude break point as option is not implemented yet
Module exports :class:`KuehnEtAl2020SInter`,
               :class:`KuehnEtAl2020SInterAlaska`,
               :class:`KuehnEtAl2020SInterCascadia`,
               :class:`KuehnEtAl2020SInterNewZealand`,
               :class:`KuehnEtAl2020SInterTaiwan`,
               :class:`KuehnEtAl2020SSlab`,
               :class:`KuehnEtAl2020SSlabAlaska`,
               :class:`KuehnEtAl2020SSlabCascadia`,
               :class:`KuehnEtAl2020SSlabNewZealand`,
               :class:`KuehnEtAl2020SSlabTaiwan`
"""
import numpy as np

from openquake.hazardlib.gsim.base import GMPE, CoeffsTable
from openquake.hazardlib import const
from openquake.hazardlib.imt import PGA, PGV, SA

class KuehnEtAl2020SInter(GMPE):
    """
    Implements NGA Subduction model KBCG20.
    For Interface events.
    """

    #: Supported tectonic region type is subduction interface
    DEFINED_FOR_TECTONIC_REGION_TYPE = const.TRT.SUBDUCTION_INTERFACE

    #: Supported intensity measure types are spectral acceleration,
    #: and peak ground acceleration
    DEFINED_FOR_INTENSITY_MEASURE_TYPES = set([
        PGA,
        PGV,
        SA
    ])

    #: Supported intensity measure component is orientation-independent
    #: average horizontal :attr:`~openquake.hazardlib.const.IMC.GMRotI50`
    DEFINED_FOR_INTENSITY_MEASURE_COMPONENT = const.IMC.RotD50

    #: Supported standard deviation types are inter-event, intra-event
    #: and total, see section "Aleatory Variability Model", page 1094.
    DEFINED_FOR_STANDARD_DEVIATION_TYPES = set([
        const.StdDev.TOTAL,
        const.StdDev.INTER_EVENT,
        const.StdDev.INTRA_EVENT
    ])

    #: Required site parameters are Vs30
    REQUIRES_SITES_PARAMETERS = {'vs30'}

    #: Required rupture parameters are magnitude and depth-to-top-of-rupture
    REQUIRES_RUPTURE_PARAMETERS = {'mag', 'ztor'}

    #: Required distance measure is Rrup
    REQUIRES_DISTANCES = {'rrup'}

    def get_mean_and_stddevs(self, sites, rup, dists, imt, stddev_types):
        """
        See :meth:`superclass method
        <.base.GroundShakingIntensityModel.get_mean_and_stddevs>`
        for spec of input and result values.
        """
        # extract dictionaries of coefficients specific to required
        # intensity measure type and for PGA
        C = self.COEFFS[imt]
        C_PGA = self.COEFFS[PGA()]

        # get magnitude break point
        m_b = self.CONSTS['m_b']

        # get magntude break poit adjustment and calculate break point
        mbreak = m_b + self._get_delta_mb(imt)

        # Get mean and standard deviation of PGA on rock (Vs30 1100 m/s^2)
        pga1100 = np.exp(self.get_mean_values(C_PGA, mbreak, sites, rup, dists, None))

        # Get mean and standard deviations for IMT
        mean = self.get_mean_values(C, mbreak, sites, rup, dists, pga1100)
        if imt.name == "SA" and imt.period <= 0.1:
            # If Sa (T) < PGA for T < 0.1 then set mean Sa(T) to mean PGA
            # Get PGA on soil
            pga = self.get_mean_values(C_PGA, mbreak, sites, rup, dists, pga1100)
            idx = mean <= pga
            mean[idx] = pga[idx]

        # Get standard deviations
        stddevs = self.get_stddevs(
            C, stddev_types, num_sites=len(sites.vs30)
        )
        return mean, stddevs

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = -1 * np.ones(len(sites.vs30))
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_magnitude_scaling_term(self, C, mbreak, mag):
        """
        Returns the magnitude scaling term (Eq. 4.4)
        """
        # put in dmb adjustment
        c_4 = self._get_magnitude_coeff(C)
        ref_m = (mbreak - self.CONSTS["Mref"])
        return self._log_hinge(mag, mbreak, c_4 * ref_m, c_4, C["c_5"], self.CONSTS["delta_m"])

    def get_geometric_attenuation_term(self, C, mag, rrup):
        """
        Returns the geometric attenuation term (Eq. 4.5)
        """
        c_2 = self._get_geometric_scaling_coeff(C)
        h = 10 ** (C["c_nft_1"] + C["c_nft_2"] * (mag - 6))
        return (c_2 + C["c_3"] * mag) * np.log(rrup + h)

    def get_anelastic_attenuation_term(self, C, dists):
        """
        Returns the anelastic attenuation term (Eq. 4.9)
        for global model, this is the base model
        """
        c_6 = self._get_anelastic_coeff(C)
        return c_6 * dists.rrup

    def get_depth_term(self, C, ztor):
        """
        Returns the Z-tor scaling term (Eq. 4.7)
        """
        c_9, dz_b = self._get_depth_coeff(C)
        z_break = self.CONSTS["z_b"] + dz_b
        ref_z = z_break - self.CONSTS["Zref"]
        return self._log_hinge(ztor, z_break, c_9 * ref_z, c_9, self.CONSTS["c_10"], self.CONSTS["delta_z"])

    def get_shallow_site_response_term(self, C, vs30, pga1100):
        """
        Returns the shallow site response term in Eq. 4.8
        """
        c_7 = self._get_linear_site_coeff(C)
        vs_mod = vs30 / C["k1"]
        f_site_g = c_7 * np.log(vs_mod)
        idx = vs30 > C["k1"]
        f_site_g[idx] = f_site_g[idx] + (C["k2"] * self.CONSTS["n"] *
                                         np.log(vs_mod[idx]))

        # Get nonlinear site response term
        idx = np.logical_not(idx)
        if np.any(idx):
            f_site_g[idx] = f_site_g[idx] + C["k2"] * (
                    np.log(pga1100[idx] +
                           self.CONSTS["c"] * (vs_mod[idx] ** self.CONSTS["n"])) -
                    np.log(pga1100[idx] + self.CONSTS["c"])
            )
        return f_site_g

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term, which for the global model is
        not defined
        """
        return 0.

    def get_base_term(self, C):
        """
        Returns the base coefficient of the GMPE, which for global interface events
        is the mean of the c1 coefficient
        This is a regionalisable coefficient and will be modified in subclasses
        """
        return C["mu_c_1_if"]

    def _get_magnitude_coeff(self, C):
        """
        This is a parameter that depends on Tectonic region
        Wll be modified in subclasses
        """
        return C["c_4_if"]

    def _get_anelastic_coeff(self, C):
        """
        This function is a regionalisable parameter - will be modified in
        other classes
        """
        return C["mu_c_6"]

    def _get_linear_site_coeff(self, C):
        """
        This function is a regionalisable parameter - will be modified in
        other classes
        """
        return C["mu_c_7"]

    def _get_geometric_scaling_coeff(self, C):
        """
        This is a parameter that depends on Tectonic region
        Wll be modified in subclasses
        """
        return C["c_2_if"]

    def _get_depth_coeff(self, C):
        """
        This is a parameter that depends on Tectonic region
        Wll be modified in subclasses
        """
        return C["c_9_if"], C["dz_b_if"]

    def _get_delta_mb(self, imt):
        """
        Returns the adjustment to the magnitude break point
        """
        return self.COEFFS_MAG_SCALE[imt]["dm_b"]

    def get_stddevs(self, C, stddev_types, num_sites):
        """
        """
        stddevs = []
        for stddev_type in stddev_types:
            assert stddev_type in self.DEFINED_FOR_STANDARD_DEVIATION_TYPES
            if stddev_type == const.StdDev.TOTAL:
                sigma_tot = np.sqrt(C["phi"] ** 2 + C["tau"] ** 2)
                stddevs.append(sigma_tot + np.zeros(num_sites))
            elif stddev_type == const.StdDev.INTRA_EVENT:
                stddevs.append(C["phi"] + np.zeros(num_sites))
            elif stddev_type == const.StdDev.INTER_EVENT:
                stddevs.append(C["tau"] + np.zeros(num_sites))
        return stddevs

    def _log_hinge(self, x, x0, a, b0, b1, delta):
        xdiff = x - x0
        return a + b0 * xdiff + (b1 - b0) * delta * np.log(1 + np.exp(xdiff / delta))

    def _get_ln_z_ref(self, vs30):
        """
        Computes the reference Z (1.0/2.5) value from Vs30
        Eq. 4.11
        """
        Cz = self.CONSTS_Z_MODEL
        diff = (np.log(vs30) - Cz["c_z_3"]) / Cz["c_z_4"]
        ln_z_ref = Cz["c_z_1"] + (Cz["c_z_2"] - Cz["c_z_1"]) * np.exp(diff) / (1 + np.exp(diff))
        return ln_z_ref


    COEFFS = CoeffsTable(sa_damping=5, table="""\
imt     mu_c_1_if  mu_c_1_slab  c_2_if    c_2_slab  c_3       c_4_if    c_4_slab  c_5       mu_c_6    mu_c_6b   mu_c_7    c_9_if    c_9_slab  c_6xc     c_1_if_reg_Al  c_1_if_reg_Ca  c_1_if_reg_CAM  c_1_if_reg_Ja  c_1_if_reg_NZ  c_1_if_reg_SA  c_1_if_reg_Tw  c_1_slab_reg_Al  c_1_slab_reg_Ca  c_1_slab_reg_CAM  c_1_slab_reg_Ja  c_1_slab_reg_NZ  c_1_slab_reg_SA  c_1_slab_reg_Tw  c_7_reg_Al  c_7_reg_Ca  c_7_reg_CAM  c_7_reg_Ja  c_7_reg_NZ  c_7_reg_SA  c_7_reg_Tw  c_6_x1_reg_Al  c_6_x1_reg_Ca  c_6_x1_reg_CAM  c_6_x1_reg_Ja  c_6_x1_reg_NZ  c_6_x1_reg_SA  c_6_x1_reg_Tw  c_6_x2_reg_Al  c_6_x2_reg_Ca  c_6_x2_reg_CAM  c_6_x2_reg_Ja  c_6_x2_reg_NZ  c_6_x2_reg_SA  c_6_x2_reg_Tw  c_6_x3_reg_Al  c_6_x3_reg_Ca  c_6_x3_reg_CAM  c_6_x3_reg_Ja  c_6_x3_reg_NZ  c_6_x3_reg_SA  c_6_x3_reg_Tw  c_6_1_reg_Al  c_6_1_reg_Ca  c_6_1_reg_CAM  c_6_1_reg_Ja  c_6_1_reg_NZ  c_6_1_reg_SA  c_6_1_reg_Tw  c_6_2_reg_Al  c_6_2_reg_Ca  c_6_2_reg_CAM  c_6_2_reg_Ja  c_6_2_reg_NZ  c_6_2_reg_SA  c_6_2_reg_Tw  c_6_3_reg_Al  c_6_3_reg_Ca  c_6_3_reg_CAM  c_6_3_reg_Ja  c_6_3_reg_NZ  c_6_3_reg_SA  c_6_3_reg_Tw  dz_b_if    dz_b_slab  c_nft_1   c_nft_2   c_11_Ca   c_12_Ca   theta_11_Sea  c_11_Ja   c_12_Ja   c_11_NZ   c_12_NZ   c_11_Tw   c_12_Tw   k1      k2     phi       tau     
   pgv  6.433543   9.435733    -2.217436 -2.669506  0.127884  1.014483  1.307578  0.123716 -0.001348 -0.002342  1.687675  0.016151  0.015521 -0.335150  6.371803       6.433418       6.411284        6.505276       6.460452       6.439995       6.434487       9.528993         9.441571         9.408429          9.561717         9.442427         9.366311         9.337388         1.331446    1.558877    1.851774     1.539524    1.786085    2.098709    1.672486   -0.002803      -0.002615      -0.002561       -0.004159      -0.002270      -0.001328      -0.002372      -0.002712      -0.002440      -0.000595       -0.001180      -0.002238      -0.001283      -0.002401      -0.002115      -0.002364      -0.002266       -0.000385      -0.002540      -0.002591      -0.002308      -0.002247     -0.002348     -0.002551      -0.002221     -0.002570     -0.002929     -0.002376     -0.001592     -0.001310     -0.000983      -0.001961     -0.000550     -0.001124     -0.001855     -0.002654     -0.002517     -0.002447      -0.004161     -0.002220     -0.002095     -0.002444      12.566095 -13.359066  0.936379  0.210943 -0.012278  0.118442  0.119977     -0.016288  0.101240  0.007889 -0.011142  0.011641  0.078625   400.0 -1.955  0.511486  0.450985
   pga  3.715307   4.789080    -2.460896 -2.438099  0.103931  0.952187  1.105012  0.128151 -0.002635 -0.005254  0.887679  0.025481  0.022385 -0.604166  3.356030       3.600305       3.696421        4.008987       3.943338       4.051210       3.446871       4.548715         4.486160         5.041801          5.360941         4.822427         5.079649         4.391530         0.560135    0.662527    1.147447     0.869726    1.005783    1.131304    0.933688   -0.005574      -0.005541      -0.006286       -0.008737      -0.005012      -0.003629      -0.004813      -0.006505      -0.006748      -0.000543       -0.002042      -0.004534      -0.002734      -0.005830      -0.005413      -0.005270      -0.005316       -0.005587      -0.005359      -0.005335      -0.005177      -0.004745     -0.004892     -0.005721      -0.005544     -0.005702     -0.007038     -0.005131     -0.002900     -0.003789     -0.001379      -0.002812     -0.001984     -0.002095     -0.003047     -0.005178     -0.004983     -0.005920      -0.008307     -0.005361     -0.005848     -0.004710      16.816058 -15.841253  0.894589  0.198851 -0.033754  0.020801 -0.126369     -0.000553 -0.027347 -0.029315 -0.083453  0.013177  0.047719   865.0 -1.186  0.595755  0.488745
  0.01  3.575653   4.559572    -2.428917 -2.395028  0.104318  0.945374  1.108607  0.129146 -0.002699 -0.005284  0.892438  0.025058  0.021964 -0.591998  3.195018       3.480335       3.521664        3.786328       3.810325       3.935535       3.311994       4.307772         4.309174         4.809797          5.048204         4.653637         4.840731         4.203531         0.571021    0.667083    1.109681     0.870923    1.012432    1.147077    0.910860   -0.005973      -0.005746      -0.006377       -0.008752      -0.005025      -0.003597      -0.004965      -0.006405      -0.006703      -0.000430       -0.002050      -0.004560      -0.002729      -0.005885      -0.005306      -0.005312      -0.005427       -0.005492      -0.005333      -0.005296      -0.005372      -0.004754     -0.005063     -0.005768      -0.005460     -0.005706     -0.006884     -0.005365     -0.002918     -0.003919     -0.001325      -0.002916     -0.001939     -0.002072     -0.003128     -0.005217     -0.005212     -0.005897      -0.008358     -0.005520     -0.005771     -0.004758      16.823813 -16.125061  0.896424  0.199092 -0.034374  0.020404 -0.126723      0.000253 -0.028776 -0.028300 -0.083199  0.012099  0.046885   865.0 -1.186  0.599596  0.494230
  0.02  3.716489   4.808207    -2.459748 -2.443224  0.104711  0.958824  1.116236  0.132407 -0.002614 -0.005324  0.930261  0.027178  0.023277 -0.619772  3.381819       3.601502       3.684087        3.966415       3.912658       4.057270       3.436771       4.585991         4.492272         5.138580          5.356058         4.860414         5.154176         4.388375         0.607154    0.707218    1.161897     0.912944    1.056041    1.208209    0.953422   -0.005949      -0.005743      -0.006273       -0.008641      -0.005121      -0.003612      -0.004936      -0.006443      -0.006944      -0.000439       -0.001984      -0.004702      -0.002811      -0.006108      -0.005316      -0.005377      -0.005471       -0.005435      -0.005328      -0.005394      -0.005463      -0.004839     -0.005007     -0.005958      -0.005698     -0.005746     -0.007151     -0.005306     -0.002925     -0.003788     -0.001329      -0.002889     -0.001895     -0.002034     -0.002916     -0.005238     -0.005291     -0.005955      -0.008231     -0.005457     -0.005810     -0.004865      16.662189 -16.284032  0.897168  0.199151 -0.034662  0.018233 -0.128641     -0.000199 -0.030457 -0.028718 -0.082966  0.011978  0.047268   865.0 -1.219  0.592415  0.505458
  0.03  4.019204   5.167198    -2.513834 -2.496445  0.104531  0.973096  1.109268  0.134843 -0.002548 -0.005442  1.012753  0.029344  0.024539 -0.654993  3.700438       3.881528       4.009647        4.346256       4.214684       4.354312       3.698231       4.947996         4.780066         5.547288          5.823779         5.176631         5.577609         4.666984         0.707423    0.782766    1.247419     1.011507    1.141593    1.276473    1.033921   -0.005875      -0.005766      -0.006266       -0.008825      -0.005277      -0.003726      -0.004932      -0.006591      -0.007211      -0.000515       -0.001952      -0.004851      -0.002909      -0.006340      -0.005433      -0.005498      -0.005577       -0.005582      -0.005449      -0.005570      -0.005546      -0.004967     -0.005036     -0.006164      -0.006002     -0.005867     -0.007533     -0.005298     -0.002937     -0.003683     -0.001376      -0.002837     -0.001911     -0.002046     -0.002688     -0.005300     -0.005346     -0.006091      -0.008232     -0.005537     -0.005971     -0.004967      17.181661 -16.314490  0.896405  0.198910 -0.032014  0.014046 -0.132861      0.001563 -0.036268 -0.032177 -0.083557  0.012910  0.047962   908.0 -1.273  0.604430  0.511668
  0.05  4.544769   5.640303    -2.589450 -2.541067  0.103376  0.991235  1.090513  0.137301 -0.002550 -0.005676  1.188013  0.031911  0.025760 -0.692566  4.217633       4.387813       4.549221        4.964188       4.772027       4.888842       4.161202       5.404896         5.191630         6.041135          6.424630         5.618999         6.114167         5.054938         0.969922    0.959354    1.368368     1.257664    1.296724    1.367020    1.187023   -0.005885      -0.005848      -0.006436       -0.009375      -0.005584      -0.003981      -0.005016      -0.006858      -0.007564      -0.000688       -0.001973      -0.005075      -0.003081      -0.006676      -0.005678      -0.005733      -0.005815       -0.006002      -0.005712      -0.005880      -0.005674      -0.005218     -0.005196     -0.006476      -0.006429     -0.006119     -0.008093     -0.005396     -0.003006     -0.003680     -0.001487      -0.002794     -0.002021     -0.002131     -0.002454     -0.005498     -0.005496     -0.006320      -0.008430     -0.005797     -0.006278     -0.005125      18.320745 -16.300176  0.893480  0.198210 -0.028009 -0.016394 -0.179041      0.009631 -0.057726 -0.044734 -0.081383  0.010570  0.032748  1054.0 -1.346  0.638019  0.515793
 0.075  4.920943   5.848238    -2.619896 -2.525556  0.101546  1.000331  1.078532  0.137915 -0.002673 -0.005933  1.372274  0.032823  0.025792 -0.695463  4.577888       4.768797       4.916525        5.361936       5.180893       5.274643       4.512720       5.599347         5.409688         6.214869          6.654076         5.835590         6.322656         5.254963         1.228310    1.183367    1.494059     1.490283    1.462358    1.469249    1.357870   -0.006040      -0.005971      -0.006747       -0.009926      -0.005871      -0.004229      -0.005202      -0.007084      -0.007762      -0.000874       -0.002086      -0.005267      -0.003241      -0.006915      -0.005932      -0.005995      -0.006062       -0.006452      -0.006006      -0.006149      -0.005850      -0.005463     -0.005449     -0.006707      -0.006712     -0.006362     -0.008416     -0.005620     -0.003105     -0.003884     -0.001609      -0.002831     -0.002194     -0.002263     -0.002470     -0.005739     -0.005721     -0.006547      -0.008744     -0.006114     -0.006531     -0.005310      18.923699 -16.240071  0.889434  0.197375 -0.033582 -0.060272 -0.261658      0.013763 -0.076256 -0.043511 -0.097524  0.013509  0.040802  1086.0 -1.471  0.666120  0.514873
   0.1  5.073490   5.830854    -2.608323 -2.477879  0.099788  1.001913  1.078729  0.137331 -0.002821 -0.006073  1.531424  0.032448  0.025081 -0.676483  4.726850       4.937742       5.053960        5.488464       5.346632       5.425393       4.676007       5.582709         5.437211         6.146774          6.587999         5.839812         6.268244         5.277205         1.387116    1.382118    1.643536     1.630929    1.625128    1.606936    1.520788   -0.006227      -0.006075      -0.007025       -0.010221      -0.006029      -0.004379      -0.005355      -0.007161      -0.007794      -0.001024       -0.002206      -0.005363      -0.003348      -0.007003      -0.006108      -0.006154      -0.006218       -0.006751      -0.006176      -0.006295      -0.005944      -0.005625     -0.005647     -0.006780      -0.006798     -0.006486     -0.008488     -0.005784     -0.003186     -0.004139     -0.001703      -0.002886     -0.002347     -0.002367     -0.002642     -0.005917     -0.005859     -0.006677      -0.009001     -0.006306     -0.006643     -0.005425      18.758649 -16.147277  0.885757  0.196698 -0.025228 -0.077067 -0.276774      0.010235 -0.068037 -0.047969 -0.124030  0.010252  0.045775  1032.0 -1.624  0.678369  0.511975
  0.15  5.025991   5.531067    -2.531738 -2.361283  0.096886  0.997174  1.099428  0.134973 -0.003085 -0.006177  1.800941  0.030226  0.022996 -0.620266  4.700169       4.927519       4.981229        5.350477       5.289008       5.350817       4.689842       5.308804         5.242301         5.751217          6.135933         5.579031         5.866442         5.092472         1.550575    1.682451    1.973241     1.786976    1.924312    1.945485    1.816594   -0.006508      -0.006200      -0.007406       -0.010371      -0.006160      -0.004489      -0.005541      -0.007131      -0.007655      -0.001237       -0.002384      -0.005422      -0.003465      -0.007001      -0.006223      -0.006283      -0.006335       -0.007034      -0.006317      -0.006365      -0.006022      -0.005773     -0.005872     -0.006752      -0.006729     -0.006541     -0.008283     -0.005971     -0.003281     -0.004590     -0.001826      -0.003045     -0.002575     -0.002507     -0.003112     -0.006151     -0.006031     -0.006786      -0.009308     -0.006455     -0.006640     -0.005557      17.286575 -15.877666  0.879903  0.195765 -0.032857 -0.051386 -0.246680     -0.009498 -0.050344 -0.039382 -0.118888  0.015652  0.040261   878.0 -1.931  0.677740  0.505515
   0.2  4.769661   5.132678    -2.434299 -2.252963  0.094745  0.990942  1.131547  0.132355 -0.003273 -0.006152  2.015482  0.027520  0.020848 -0.563794  4.481015       4.702099       4.710481        5.005995       5.002107       5.054294       4.504351       4.947768         4.932355         5.279849          5.591939         5.203980         5.371817         4.803260         1.651087    1.889591    2.261113     1.896749    2.157453    2.274056    2.057558   -0.006651      -0.006196      -0.007598       -0.010205      -0.006160      -0.004465      -0.005625      -0.006969      -0.007424      -0.001376       -0.002505      -0.005392      -0.003503      -0.006876      -0.006216      -0.006276      -0.006319       -0.007089      -0.006304      -0.006298      -0.006017      -0.005815     -0.005951     -0.006597      -0.006540     -0.006456     -0.007916     -0.006039     -0.003330     -0.004916     -0.001892      -0.003173     -0.002722     -0.002565     -0.003563     -0.006264     -0.006081     -0.006773      -0.009406     -0.006447     -0.006484     -0.005593      15.321677 -15.526638  0.875691  0.195220 -0.034588 -0.016656 -0.174198     -0.013802 -0.035031 -0.025001 -0.089642  0.014436  0.042213   748.0 -2.188  0.664654  0.500076
  0.25  4.441348   4.737977    -2.338216 -2.162150  0.093177  0.986669  1.166600  0.129945 -0.003413 -0.006065  2.182528  0.024917  0.018907 -0.513766  4.192964       4.396801       4.375634        4.606384       4.638720       4.683924       4.239805       4.590721         4.604524         4.832426          5.079309         4.820203         4.898130         4.497810         1.742163    2.041945    2.476116     1.995613    2.324779    2.542924    2.242567   -0.006688      -0.006126      -0.007674       -0.009923      -0.006086      -0.004392      -0.005641      -0.006760      -0.007178      -0.001477       -0.002617      -0.005338      -0.003512      -0.006707      -0.006158      -0.006199      -0.006240       -0.007029      -0.006216      -0.006172      -0.005958      -0.005804     -0.005942     -0.006413      -0.006337     -0.006327     -0.007514     -0.006006     -0.003360     -0.005140     -0.001937      -0.003288     -0.002818     -0.002591     -0.003945     -0.006273     -0.006060     -0.006693      -0.009368     -0.006349     -0.006279     -0.005597      13.374937 -15.126413  0.872636  0.194916 -0.031240  0.035524 -0.087996     -0.008879 -0.022592 -0.022149 -0.118750  0.021984  0.050554   654.0 -2.381  0.649528  0.495846
   0.3  4.095960   4.374731    -2.250205 -2.088032  0.092032  0.985056  1.201258  0.127846 -0.003508 -0.005954  2.307342  0.022575  0.017207 -0.470368  3.885682       4.068026       4.028588        4.206322       4.259728       4.299053       3.947874       4.261667         4.290405         4.431418          4.624839         4.459910         4.472629         4.204567         1.826956    2.156155    2.621751     2.081212    2.438066    2.742513    2.376440   -0.006654      -0.006032      -0.007688       -0.009600      -0.005988      -0.004291      -0.005632      -0.006534      -0.006943      -0.001559       -0.002684      -0.005270      -0.003502      -0.006534      -0.006056      -0.006096      -0.006135       -0.006912      -0.006086      -0.006020      -0.005874      -0.005759     -0.005905     -0.006212      -0.006134     -0.006177     -0.007117     -0.005957     -0.003363     -0.005276     -0.001960      -0.003360     -0.002882     -0.002588     -0.004250     -0.006235     -0.005989     -0.006589      -0.009257     -0.006233     -0.006069     -0.005578      11.613497 -14.699405  0.870399  0.194766 -0.027222  0.051800 -0.046549     -0.010823 -0.005372 -0.010104 -0.084008  0.019670  0.053315   587.0 -2.518  0.635787  0.492609
   0.4  3.433449   3.757220    -2.102935 -1.979317  0.090584  0.989150  1.265049  0.124505 -0.003620 -0.005710  2.444039  0.018723  0.014446 -0.399165  3.287036       3.425683       3.370174        3.472405       3.541018       3.570140       3.364051       3.699186         3.734440         3.767458          3.885418         3.835827         3.769548         3.682761         1.949962    2.287970    2.748279     2.186512    2.540737    2.955972    2.511423   -0.006485      -0.005821      -0.007570       -0.008950      -0.005756      -0.004090      -0.005518      -0.006102      -0.006504      -0.001669       -0.002778      -0.005106      -0.003457      -0.006192      -0.005843      -0.005840      -0.005895       -0.006622      -0.005827      -0.005734      -0.005692      -0.005603     -0.005732     -0.005835      -0.005769     -0.005857     -0.006400     -0.005763     -0.003363     -0.005410     -0.001984      -0.003454     -0.002936     -0.002556     -0.004668     -0.006101     -0.005823     -0.006352      -0.008915     -0.005927     -0.005656     -0.005470       8.768200 -13.818273  0.867543  0.194726 -0.045715  0.110659  0.023018     -0.013931  0.030155  0.007677 -0.045938  0.016889  0.051926   503.0 -2.657  0.615315  0.488215
   0.5  2.846435   3.265244    -1.989991 -1.907871  0.089848  1.000680  1.320126  0.122092 -0.003628 -0.005454  2.451674  0.015823  0.012345 -0.342272  2.747332       2.848400       2.791079        2.847101       2.912944       2.933256       2.827443       3.246231         3.274078         3.251794          3.324407         3.330662         3.227339         3.246846         1.984421    2.302688    2.718123     2.187921    2.519785    2.980301    2.502296   -0.006235      -0.005580      -0.007357       -0.008356      -0.005503      -0.003889      -0.005353      -0.005720      -0.006120      -0.001736       -0.002829      -0.004930      -0.003384      -0.005877      -0.005591      -0.005573      -0.005633       -0.006313      -0.005552      -0.005429      -0.005466      -0.005416     -0.005519     -0.005510      -0.005469     -0.005559     -0.005797     -0.005533     -0.003303     -0.005393     -0.001976      -0.003482     -0.002924     -0.002492     -0.004878     -0.005888     -0.005601     -0.006063      -0.008492     -0.005621     -0.005298     -0.005319       6.728119 -12.947979  0.866017  0.194876 -0.031600  0.129282  0.099229     -0.019981  0.074733  0.016126 -0.019815  0.018284  0.065895   457.0 -2.669  0.603263  0.485607
  0.75  1.701640   2.398837    -1.811385 -1.818966  0.089518  1.047321  1.426015  0.118614 -0.003470 -0.004892  2.096480  0.011352  0.008821 -0.233915  1.669392       1.708937       1.666433        1.673875       1.712003       1.715470       1.739913       2.431124         2.429917         2.368039          2.394375         2.430572         2.313242         2.434938         1.732147    1.969236    2.279571     1.837323    2.140887    2.590645    2.089380   -0.005576      -0.005020      -0.006700       -0.007178      -0.004932      -0.003436      -0.004928      -0.004963      -0.005355      -0.001822       -0.002874      -0.004510      -0.003184      -0.005217      -0.005027      -0.004974      -0.005049       -0.005618      -0.004933      -0.004801      -0.004962      -0.004947     -0.005005     -0.004836      -0.004887     -0.004918     -0.004647     -0.004990     -0.003076     -0.005049     -0.001916      -0.003411     -0.002787     -0.002311     -0.004934     -0.005332     -0.005063     -0.005419      -0.007421     -0.004987     -0.004591     -0.004903       3.964760 -10.953227  0.864983  0.195520 -0.032779  0.184908  0.209579     -0.024187  0.141359  0.012059  0.004011  0.006109  0.085523   410.0 -2.401  0.594773  0.482859
     1  0.890492   1.829616    -1.719993 -1.791481  0.090096  1.103814  1.500926  0.117157 -0.003218 -0.004405  1.516382  0.009168  0.006645 -0.150852  0.883999       0.894850       0.869768        0.868523       0.880915       0.873662       0.941449       1.877900         1.855767         1.801357          1.819634         1.837888         1.742139         1.870986         1.245808    1.400361    1.664982     1.264854    1.572666    1.980834    1.460665   -0.004962      -0.004537      -0.006054       -0.006320      -0.004447      -0.003084      -0.004507      -0.004400      -0.004769      -0.001847       -0.002815      -0.004135      -0.002973      -0.004689      -0.004537      -0.004462      -0.004545       -0.005065      -0.004429      -0.004296      -0.004506      -0.004518     -0.004532     -0.004303      -0.004448     -0.004405     -0.003842     -0.004520     -0.002836     -0.004565     -0.001838      -0.003230     -0.002607     -0.002133     -0.004674     -0.004796     -0.004592     -0.004850      -0.006464     -0.004457     -0.004080     -0.004491       2.998396  -9.255852  0.865596  0.196227 -0.029058  0.173916  0.236757     -0.002671  0.188750  0.030448  0.044832  0.015145  0.110850   400.0 -1.955  0.598970  0.482329
   1.5 -0.175097   1.090154    -1.652688 -1.797804  0.091897  1.215947  1.600756  0.116773 -0.002748 -0.003684  0.459844  0.007815  0.004020 -0.023750 -0.176119      -0.177633      -0.180840       -0.172629      -0.186117      -0.203168      -0.135477       1.133013         1.097427         1.074441          1.099620         1.077222         1.029526         1.110182         0.310304    0.356550    0.592746     0.224216    0.544469    0.913347    0.346959   -0.004028      -0.003785      -0.004995       -0.005172      -0.003700      -0.002567      -0.003845      -0.003638      -0.003923      -0.001845       -0.002740      -0.003545      -0.002612      -0.003903      -0.003790      -0.003709      -0.003780       -0.004274      -0.003690      -0.003552      -0.003798      -0.003828     -0.003795     -0.003585      -0.003829     -0.003643     -0.002796     -0.003790     -0.002409     -0.003667     -0.001701      -0.002862     -0.002268     -0.001875     -0.003939     -0.003950     -0.003827     -0.003965      -0.004955     -0.003703     -0.003409     -0.003795       2.958590  -6.600575  0.868036  0.197459 -0.023876  0.201715  0.286400      0.004608  0.249536  0.043018  0.094099  0.022357  0.151252   400.0 -1.025  0.611546  0.482850
     2 -0.854227   0.586593    -1.646035 -1.825030  0.093684  1.313705  1.666320  0.117651 -0.002340 -0.003172 -0.176024  0.008070  0.002398  0.069323 -0.866431      -0.859883      -0.854613       -0.836519      -0.854159      -0.872871      -0.832154       0.612013         0.582327         0.579302          0.610200         0.570044         0.552350         0.585691        -0.281251   -0.262818   -0.063796    -0.399937   -0.082811    0.274633   -0.315466   -0.003377      -0.003258      -0.004207       -0.004419      -0.003164      -0.002182      -0.003356      -0.003136      -0.003329      -0.001810       -0.002643      -0.003099      -0.002329      -0.003348      -0.003257      -0.003176      -0.003249       -0.003711      -0.003171      -0.003040      -0.003283      -0.003309     -0.003265     -0.003100      -0.003379     -0.003121     -0.002151     -0.003287     -0.002064     -0.002921     -0.001592      -0.002515     -0.001982     -0.001685     -0.003235     -0.003330     -0.003271     -0.003335      -0.003869     -0.003190     -0.002980     -0.003263       3.467766  -4.646263  0.870534  0.198405 -0.039218  0.230982  0.282358     -0.014419  0.280580  0.046788  0.112241  0.013478  0.168365   400.0 -0.299  0.617348  0.483536
     3 -1.707597  -0.146184    -1.676629 -1.875876  0.096502  1.463120  1.752684  0.120191 -0.001757 -0.002495 -0.592415  0.009820  0.000279  0.186616 -1.739858      -1.712326      -1.706495       -1.684797      -1.689675      -1.703079      -1.706174      -0.149235        -0.154870        -0.148164         -0.120412        -0.154813        -0.151733        -0.166119        -0.721297   -0.638106   -0.544893    -0.802764   -0.498045   -0.174359   -0.749483   -0.002572      -0.002532      -0.003144       -0.003444      -0.002447      -0.001633      -0.002667      -0.002509      -0.002538      -0.001694       -0.002464      -0.002467      -0.001880      -0.002609      -0.002556      -0.002474      -0.002535       -0.003000      -0.002489      -0.002362      -0.002587      -0.002609     -0.002541     -0.002463      -0.002735     -0.002425     -0.001389     -0.002607     -0.001585     -0.001910     -0.001408      -0.001985     -0.001552     -0.001416     -0.002186     -0.002520     -0.002547     -0.002511      -0.002522     -0.002513     -0.002436     -0.002518       3.927270  -1.994229  0.874446  0.199694  0.000421  0.210506  0.286273      0.017050  0.305661  0.058672  0.124638  0.025344  0.157175   400.0  0.000  0.609291  0.484022
     4 -2.257680  -0.711213    -1.709830 -1.908284  0.098438  1.566046  1.811761  0.122612 -0.001377 -0.002044 -0.585389  0.011724 -0.001183  0.242311 -2.296566      -2.258376      -2.257421       -2.243242      -2.233628      -2.239112      -2.261116      -0.727215        -0.714678        -0.713875         -0.696792        -0.710637        -0.708760        -0.732028        -0.765949   -0.592150   -0.580628    -0.780816   -0.483198   -0.205314   -0.741057   -0.002111      -0.002046      -0.002479       -0.002803      -0.001988      -0.001226      -0.002211      -0.002115      -0.002029      -0.001585       -0.002315      -0.002036      -0.001554      -0.002134      -0.002100      -0.002026      -0.002068       -0.002528      -0.002046      -0.001926      -0.002128      -0.002159     -0.002068     -0.002047      -0.002283     -0.001984     -0.000954     -0.002166     -0.001279     -0.001296     -0.001271      -0.001631     -0.001265     -0.001220     -0.001523     -0.002018     -0.002083     -0.002008      -0.001761     -0.002083     -0.002080     -0.002035       3.370656  -0.305375  0.877064  0.200494  0.018832  0.244947  0.448002      0.052368  0.307164  0.042134  0.136546  0.030811  0.132087   400.0  0.000  0.587788  0.483600
     5 -2.663616  -1.182577    -1.732636 -1.925829  0.099774  1.637883  1.857447  0.124654 -0.001124 -0.001734 -0.512671  0.013387 -0.002311  0.259027 -2.699286      -2.660213      -2.663635       -2.659024      -2.640906      -2.638955      -2.664492      -1.200297        -1.179600        -1.186649         -1.179522        -1.176416        -1.181004        -1.197658        -0.724174   -0.487937   -0.519162    -0.687582   -0.401493   -0.159049   -0.659580   -0.001823      -0.001708      -0.002043       -0.002345      -0.001673      -0.000896      -0.001892      -0.001845      -0.001680      -0.001485       -0.002174      -0.001731      -0.001301      -0.001805      -0.001787      -0.001718      -0.001752       -0.002184      -0.001737      -0.001625      -0.001805      -0.001854     -0.001741     -0.001745      -0.001952     -0.001682     -0.000682     -0.001861     -0.001074     -0.000913     -0.001168      -0.001413     -0.001062     -0.001081     -0.001110     -0.001691     -0.001770     -0.001683      -0.001312     -0.001777     -0.001824     -0.001705       2.129627   0.840704  0.878804  0.201026  0.016383  0.261637  0.521325      0.010242  0.292740  0.044755  0.159273  0.012982  0.135285   400.0  0.000  0.562102  0.482730
   7.5 -3.368097  -2.100674    -1.750019 -1.933397  0.101594  1.738644  1.941358  0.128328 -0.000826 -0.001280 -0.431587  0.016399 -0.004287  0.209134 -3.376621      -3.357721      -3.365219       -3.375555      -3.360428      -3.344668      -3.355595      -2.098557        -2.089046        -2.103672         -2.106138        -2.094424        -2.109619        -2.099843        -0.631117   -0.364709   -0.410008    -0.549708   -0.332415   -0.113042   -0.551929   -0.001460      -0.001222      -0.001463       -0.001598      -0.001234      -0.000341      -0.001417      -0.001444      -0.001182      -0.001287       -0.001935      -0.001277      -0.000902      -0.001338      -0.001344      -0.001281      -0.001288       -0.001593      -0.001284      -0.001207      -0.001341      -0.001427     -0.001261     -0.001293      -0.001426     -0.001252     -0.000347     -0.001401     -0.000868     -0.000495     -0.001003      -0.001219     -0.000774     -0.000875     -0.000666     -0.001263     -0.001354     -0.001270      -0.000881     -0.001335     -0.001401     -0.001262      -2.254304   2.472428  0.881005  0.201732  0.012890  0.220665  0.485046     -0.005722  0.248740  0.037142  0.126677  0.013252  0.125747   400.0  0.000  0.500922  0.480025
    10 -3.837779  -2.768999    -1.735295 -1.918144  0.102312  1.780438  2.000913  0.130643 -0.000728 -0.001042 -0.428491  0.018282 -0.005541  0.101221 -3.812918      -3.824348      -3.829129       -3.838503      -3.845875      -3.821734      -3.816493      -2.735575        -2.759945        -2.764280         -2.756891        -2.773092        -2.784359        -2.761835        -0.569527   -0.362123   -0.387004    -0.505966   -0.387988   -0.143450   -0.531306   -0.001304      -0.000969      -0.001212       -0.001164      -0.001032       0.000029      -0.001172      -0.001228      -0.000956      -0.001137       -0.001776      -0.001050      -0.000652      -0.001120      -0.001123      -0.001069      -0.001052       -0.001234      -0.001047      -0.000998      -0.001106      -0.001238     -0.001011     -0.001036      -0.001158     -0.001051     -0.000235     -0.001149     -0.000830     -0.000390     -0.000899      -0.001253     -0.000635     -0.000737     -0.000611     -0.001084     -0.001166     -0.001122      -0.000846     -0.001086     -0.001146     -0.001075      -6.949083   3.239206  0.881692  0.202004  0.015757  0.186337  0.402734     -0.012161  0.214443  0.020092  0.109094 -0.002629  0.112043   400.0  0.000  0.453378  0.477483
        """)

    COEFFS_MAG_SCALE = CoeffsTable(sa_damping=5, table="""
    imt   dm_b
    pgv   -0.2
    pga   0.
    0.01  0.
    0.02  0.
    0.03  0.
    0.05  0.
    0.075 0.
    0.1   0.
    0.15  0.
    0.2   0.
    0.25  0.
    0.3   0.
    0.4   0.
    0.5   0.
    0.75  0.
    1.    0.
    1.5   -0.1476281
    2.    -0.2523719
    3.    -0.4
    4.    -0.4
    5.    -0.4
    7.5   -0.4
    10.   -0.4
        """)

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 15,
              "z_b": 30,
              "m_b":7.9}

    CONSTS_Z_MODEL = {"c_z_1":0,
                      "c_z_2":0,
                      "c_z_3":0,
                      "c_z_4":0}


class KuehnEtAl2020SInterAlaska(KuehnEtAl2020SInter):
    """
    Implements the regional model for Alaska
    """

    def get_base_term(self, C):
        """
        Returns the constant coefficient for Alaska
        """
        return C["c_1_if_reg_Al"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for Alaska
        """
        return C["c_6_2_reg_Al"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for Alaska
        """
        return C["c_7_reg_Al"]

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 15,
              "z_b": 30,
              "m_b": 8.6}

class KuehnEtAl2020SInterCascadia(KuehnEtAl2020SInter):
    """
    Implements the regional model for Cascadia
    """
    #: Required site parameters are Vs30, Vs30 type (measured or inferred),
    #: and depth (km) to the 2.5 km/s shear wave velocity layer (z2pt5)
    REQUIRES_SITES_PARAMETERS = {'vs30', 'z2pt5'}

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = sites.z2pt5
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_base_term(self, C):
        """
        Returns the constant coefficient for Cascadia
        """
        return C["c_1_if_reg_Ca"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for Cascadia
        """
        return C["c_6_2_reg_Ca"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for Cascadia
        """
        return C["c_7_reg_Ca"]

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term (Eq. 4.10)
        """
        mask = (z_value > 0)
        brt = np.zeros_like(z_value)
        brt[mask] = C["c_11_Ca"] + C["c_12_Ca"] * \
                    (np.log(z_value[mask]) - self._get_ln_z_ref(vs30[mask]))
        return brt

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 15,
              "z_b": 30,
              "m_b": 8.}

    CONSTS_Z_MODEL = {"c_z_1": 8.294049640102028,
                      "c_z_2": 2.302585092994046,
                      "c_z_3": 6.396929655216146,
                      "c_z_4": 0.27081458999999997}

# class KuehnEtAl2020SInterCentralAmericaMexico(KuehnEtAl2020SInter):
#     """
#     Implements the regional interface model for Central America and Mexico
#     """
#
#     #: Distance fraction in backarc
#     DISTANCE_FRACTION = {'alpha_backarc'}
#
#     def get_anelastic_attenuation_term(self, C, dists):
#         """
#         Returns the anelastic attenuation term (Eq. 4.9)
#         Depends on forearc/backarc attenuation
#         Depends on arc crossing path
#         alpha is fraction of path in backarc
#         """
#         [c_6xc, c_6_x1, c_6_x2, c_6_1, c_6_2] = self._get_anelastic_coeff(C)
#         r1 = dists.alpha_backarc * dists.rrup # distance in backarc
#         r2 = dists.rrup - r1                  # distance in forearc
#
#         fx = np.ones(len(r1))
#         fx[dists.alpha_backarc == 0] = 0
#         fx[dists.alpha_backarc == 1] = 0
#         return fx * (c_6xc + c_6_x1 * 1 + c_6_x2 * r2) + (1 - fx) * (c_6_1 * r1 + c_6_2 * r2)
#
#     def get_base_term(self, C):
#         """
#         Returns the constant coefficient for Central America and Mexico
#         """
#         return C["c_1_if_reg_CAM"]
#
#     def _get_anelastic_coeff(self, C):
#         """
#         Returns the anelastic coefficient for Central America and Mexico
#         """
#         return C[["c_6xc", "c_6_x1_reg_CAM", "c_6_x2_reg_CAM", "c_6_1_reg_CAM", "c_6_2_reg_CAM"]]
#
#     def _get_linear_site_coeff(self, C):
#         """
#         Returns the linear site scaling coefficient for Central America and Mexico
#         """
#         return C["c_7_reg_CAM"]
#
#     CONSTS = {"c_10": 0.0,
#               "c": 1.88,
#               "n": 1.18,
#               "delta_m": 0.1,
#               "delta_z": 1,
#               "Mref": 6.0,
#               "Zref": 15,
#               "z_b": 30,
#               "m_b": 7.5}


# class KuehnEtAl2020SInterJapan(KuehnEtAl2020SInter):
#     """
#     Implements the regional interface model for Japan
#     """
#
#     #: Required site parameters are Vs30, Vs30 type (measured or inferred),
#     #: and depth (km) to the 2.5 km/s shear wave velocity layer (z2pt5)
#     REQUIRES_SITES_PARAMETERS = {'vs30', 'z2pt5'}
#
#     #: Required distance measure is Rrup and fraction in backarc
#     #: and fraction in Nankai region
#     REQUIRES_DISTANCES = set(('rrup', 'alpha_backarc', 'alpha_nankai'))
#
#     def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
#         """
#         Returns the mean values for a specific IMT
#         """
#         if isinstance(a1100, np.ndarray):
#             # Site model defined
#             temp_vs30 = sites.vs30
#             temp_z = sites.z2pt5
#         else:
#             # Default site and basin model
#             temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
#             temp_z = -1 * np.ones(len(sites.vs30))
#
#         return (self.get_base_term(C) +
#                 self.get_magnitude_scaling_term(C, m_b, rup.mag) +
#                 self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
#                 self.get_shallow_site_response_term(C, temp_vs30, a1100) +
#                 self.get_basin_response_term(C, temp_z, temp_vs30) +
#                 self.get_depth_term(C, rup.ztor) +
#                 self.get_anelastic_attenuation_term(C, dists))
#
#     def get_anelastic_attenuation_term(self, C, dists):
#         """
#         Returns the anelastic attenuation term (Eq. 4.9)
#         Depends on forearc/backarc attenuation
#         Depends on arc crossing path
#         """
#         [c_6xc, c_6_x1, c_6_x2, c_6_x3, c_6_1, c_6_2, c_6_3] = self._get_anelastic_coeff(C)
#         r1 = dists.alpha_backarc * dists.rrup
#         r3 = dists.alpha_nankai * dists.rrup
#         r2 = rrup - r1 - r3
#
#         # NEEDS WORK
#         fx = np.ones(len(r1))
#         fx[dists.alpha_backarc == 0] = 0
#         fx[dists.alpha_backarc == 1] = 0
#         return fx * (c_6xc + c_6_x1 * 1 + c_6_x2 * r2 + c_6_x3 * r3) + (1 - fx) * (c_6_1 * r1 + c_6_2 * r2 + c_6_3 * r3)
#
#     def get_base_term(self, C):
#         """
#         Returns the constant coefficient for Japan
#         """
#         return C["c_1_if_reg_Ja"]
#
#     def _get_anelastic_coeff(self, C):
#         """
#         Returns the anelastic coefficients for Japan
#         """
#         return C[["c_6xc", "c_6_x1_reg_Ja", "c_6_x2_reg_Ja", "c_6_x3_reg_Ja",\
#                   "c_6_1_reg_Ja", "c_6_2_reg_Ja", "c_6_3_reg_Ja"]]
#
#     def _get_linear_site_coeff(self, C):
#         """
#         Returns the linear site scaling coefficient for Japan
#         """
#         return C["c_7_reg_Ja"]
#
#     def get_basin_response_term(self, C, z_value, vs30):
#         """
#         Returns the basin response term (Eq. 4.10)
#         """
#         if (z_value <= 0):
#             return 0.
#         else:
#             ln_z_ref = self._get_ln_z_ref(vs30)
#             return C["c_11_Ja"] + C["c_12_Ja"] * (np.log(z_value) - ln_z_ref)
#
#     CONSTS = {"c_10": 0.0,
#               "c": 1.88,
#               "n": 1.18,
#               "delta_m": 0.1,
#               "delta_z": 1,
#               "Mref": 6.0,
#               "Zref": 15,
#               "z_b": 30,
#               "m_b": 8.5}
#
#     CONSTS_Z_MODEL = {"c_z_1": 7.689368537500001,
#                       "c_z_2": 2.302585092994046,
#                       "c_z_3": 6.309186400000001,
#                       "c_z_4": 0.7528670225000001}


class KuehnEtAl2020SInterNewZealand(KuehnEtAl2020SInter):
    """
    Implements the regional interface model for New Zealand
    """

    #: Required site parameters are Vs30, Vs30 type (measured or inferred),
    #: and depth (km) to the 1.0 km/s shear wave velocity layer (z2pt5)
    REQUIRES_SITES_PARAMETERS = {'vs30', 'z1pt0'}

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = sites.z1pt0
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_base_term(self, C):
        """
        Returns the constant coefficient for New Zealand
        """
        return C["c_1_if_reg_NZ"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for New Zealand
        """
        return C["c_6_2_reg_NZ"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for New Zealand
        """
        return C["c_7_reg_NZ"]

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term (Eq. 4.10)
        """
        mask = (z_value > 0)
        brt = np.zeros_like(z_value)
        brt[mask] = C["c_11_NZ"] + C["c_12_NZ"] * \
                    (np.log(z_value[mask]) - self._get_ln_z_ref(vs30[mask]))
        return brt

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 15,
              "z_b": 30,
              "m_b": 8.3}

    CONSTS_Z_MODEL = {"c_z_1": 6.859789675000001,
                      "c_z_2": 2.302585092994046,
                      "c_z_3": 5.745692775,
                      "c_z_4": 0.91563524375}


# class KuehnEtAl2020SInterSouthAmerica(KuehnEtAl2020SInter):
#     """
#     Implements the regional interface model for South America
#     """
#
#     #: Required distance measure is Rrup and fraction in backarc
#     REQUIRES_DISTANCES = set(('rrup', 'alpha_backarc'))
#
#     def get_anelastic_attenuation_term(self, C, dists):
#         """
#         Returns the anelastic attenuation term (Eq. 4.9)
#         Depends on forearc/backarc attenuation
#         Depends on arc crossing path
#         alpha is fraction of path in backarc
#         """
#         [c_6xc, c_6_x1, c_6_x2, c_6_1, c_6_2] = self._get_anelastic_coeff(C)
#         r1 = dists.alpha_backarc * dists.rrup
#         r2 = dists.rrup - r1
#
#         fx = np.ones(len(r1))
#         fx[dists.alpha_backarc == 0] = 0
#         fx[dists.alpha_backarc == 1] = 0
#         return fx * (c_6xc + c_6_x1 * 1 + c_6_x2 * r2) + (1 - fx) * (c_6_1 * r1 + c_6_2 * r2)
#
#     def get_base_term(self, C):
#         """
#         Returns the constant coefficient for South America
#         """
#         return C["c_1_if_reg_SA"]
#
#     def _get_anelastic_coeff(self, C):
#         """
#         Returns the anelastic coefficient for South America
#         """
#         return C[["c_6xc", "c_6_x1_reg_SA", "c_6_x2_reg_SA", "c_6_1_reg_SA", "c_6_2_reg_SA"]]
#
#     def _get_linear_site_coeff(self, C):
#         """
#         Returns the linear site scaling coefficient for South America
#         """
#         return C["c_7_reg_SA"]
#
#     CONSTS = {"c_10": 0.0,
#               "c": 1.88,
#               "n": 1.18,
#               "delta_m": 0.1,
#               "delta_z": 1,
#               "Mref": 6.0,
#               "Zref": 15,
#               "z_b": 30,
#               "m_b": 8.6}


class KuehnEtAl2020SInterTaiwan(KuehnEtAl2020SInter):
    """
    Implements the regional interface model for Taiwan
    """

    #: Required site parameters are Vs30, Vs30 type (measured or inferred),
    #: and depth (km) to the 1.0 km/s shear wave velocity layer (z2pt5)
    REQUIRES_SITES_PARAMETERS = {'vs30', 'z1pt0'}

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = sites.z1pt0
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_base_term(self, C):
        """
        Returns the constant coefficient for Taiwan
        """
        return C["c_1_if_reg_Tw"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for Taiwan
        """
        return C["c_6_2_reg_Tw"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for Taiwan
        """
        return C["c_7_reg_Tw"]

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term (Eq. 4.10)
        """
        mask = (z_value > 0)
        brt = np.zeros_like(z_value)
        brt[mask] = C["c_11_Tw"] + C["c_12_Tw"] * \
                    (np.log(z_value[mask]) - self._get_ln_z_ref(vs30[mask]))
        return brt

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 15,
              "z_b": 30,
              "m_b": 7.1}

    CONSTS_Z_MODEL = {"c_z_1": 6.30560665,
                      "c_z_2": 2.302585092994046,
                      "c_z_3": 6.1104992125,
                      "c_z_4": 0.43671101999999995}


class KuehnEtAl2020SSlab(KuehnEtAl2020SInter):
    """
    Implements NGA Subduction model KBCG20 for Intraslab events.
    This class implements the global model.
    Adjustments to the interface model are
        different constant
        different magnitude scaling coefficent
        different geometrical spreading coefficient
        no magnitude break adjustment at long periods
        different depth scaling and adjustment to break point
        different depth centering and break point
        different default magnitude break point
    """

    #: Supported tectonic region type is subduction in-slab
    DEFINED_FOR_TECTONIC_REGION_TYPE = const.TRT.SUBDUCTION_INTRASLAB

    def get_base_term(self, C):
        """
        Returns the base coefficient of the GMPE
        """
        return C["mu_c_1_slab"]

    def _get_magnitude_coeff(self, C):
        """
        This is a parameter that depends on Tectonic region
        """
        return C["c_4_slab"]

    def _get_geometric_scaling_coeff(self, C):
        """
        This is a parameter that depends on Tectonic region
        """
        return C["c_2_slab"]

    def _get_depth_coeff(self, C):
        """
        These are parameters that depends on Tectonic region
        """
        return C["c_9_slab"], C["dz_b_slab"]

    def _get_delta_mb(self, imt):
        """
        Resturns the adjustmet to the magnitude break point.
        For intraslab events, this adjustment is zero.
        """
        return 0.

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 50,
              "z_b": 80,
              "m_b": 7.6}

class KuehnEtAl2020SSlabAlaska(KuehnEtAl2020SSlab):
    """
    Implements the regional intraslab model for Alaska
    """

    def get_base_term(self, C):
        """
        Returns the constant coefficient for Alaska
        """
        return C["c_1_slab_reg_Al"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for Alaska
        """
        return C["c_6_2_reg_Al"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for Alaska
        """
        return C["c_7_reg_Al"]

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 50,
              "z_b": 80,
              "m_b": 7.2}

class KuehnEtAl2020SSlabCascadia(KuehnEtAl2020SSlab):
    """
    Implements the regional intraslab model for Cascadia
    """
    #: Required site parameters are Vs30, Vs30 type (measured or inferred),
    #: and depth (km) to the 2.5 km/s shear wave velocity layer (z2pt5)
    REQUIRES_SITES_PARAMETERS = {'vs30', 'z2pt5'}

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = sites.z2pt5
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_base_term(self, C):
        """
        Returns the constant coefficient for Cascadia
        """
        return C["c_1_slab_reg_Ca"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for Cascadia
        """
        return C["c_6_2_reg_Ca"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for Cascadia
        """
        return C["c_7_reg_Ca"]

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term (Eq. 4.10)
        """
        mask = (z_value > 0)
        brt = np.zeros_like(z_value)
        brt[mask] = C["c_11_Ca"] + C["c_12_Ca"] * \
                    (np.log(z_value[mask]) - self._get_ln_z_ref(vs30[mask]))
        return brt

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 50,
              "z_b": 80,
              "m_b": 7.2}

    CONSTS_Z_MODEL = {"c_z_1": 8.294049640102028,
                      "c_z_2": 2.302585092994046,
                      "c_z_3": 6.396929655216146,
                      "c_z_4": 0.27081458999999997}

# class KuehnEtAl2020SSlabCentralAmericaMexico(KuehnEtAl2020SSlab):
#     """
#     Implements the regional intraslab model for Central America and Mexico
#     """
#
#     #: Required distance measure is Rrup and fraction in backarc
#     REQUIRES_DISTANCES = set(('rrup', 'alpha_backarc'))
#
#     def get_anelastic_attenuation_term(self, C, dists):
#         """
#         Returns the anelastic attenuation term (Eq. 4.9)
#         Depends on forearc/backarc attenuation
#         Depends on arc crossing path
#         alpha is fraction of path in backarc
#         """
#         [c_6xc, c_6_x1, c_6_x2, c_6_1, c_6_2] = self._get_anelastic_coeff(C)
#         r1 = dists.alpha_backarc * dists.rrup
#         r2 = dists.rrup - r1
#
#         fx = np.ones(len(r1))
#         fx[dists.alpha_backarc == 0] = 0
#         fx[dists.alpha_backarc == 1] = 0
#         return fx * (c_6xc + c_6_x1 * 1 + c_6_x2 * r2) + (1 - fx) * (c_6_1 * r1 + c_6_2 * r2)
#
#     def get_base_term(self, C):
#         """
#         Returns the constant coefficient for Central America and Mexico
#         """
#         return C["c_1_slab_reg_CAM"]
#
#     def _get_anelastic_coeff(self, C):
#         """
#         Returns the anelastic coefficient for Central America and Mexico
#         """
#         return C[["c_6xc", "c_6_x1_reg_CAM", "c_6_x2_reg_CAM", "c_6_1_reg_CAM", "c_6_2_reg_CAM"]]
#
#     def _get_linear_site_coeff(self, C):
#         """
#         Returns the linear site scaling coefficient for Central America and Mexico
#         """
#         return C["c_7_reg_CAM"]
#
#     CONSTS = {"c_10": 0.0,
#               "c": 1.88,
#               "n": 1.18,
#               "delta_m": 0.1,
#               "delta_z": 1,
#               "Mref": 6.0,
#               "Zref": 50,
#               "z_b": 80,
#               "m_b": 7.4}

# class KuehnEtAl2020SSlabJapan(KuehnEtAl2020SSlab):
#     """
#     Implements the regional intraslab model for Japan
#     """
#
#     #: Required site parameters are Vs30, Vs30 type (measured or inferred),
#     #: and depth (km) to the 2.5 km/s shear wave velocity layer (z2pt5)
#     REQUIRES_SITES_PARAMETERS = {'vs30', 'z2pt5'}
#
#     #: Required distance measure is Rrup and fraction in backarc
#     #: and fraction in Nankai region
#     REQUIRES_DISTANCES = set(('rrup', 'alpha_backarc', 'alpha_nankai'))
#
#     def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
#         """
#         Returns the mean values for a specific IMT
#         """
#         if isinstance(a1100, np.ndarray):
#             # Site model defined
#             temp_vs30 = sites.vs30
#             temp_z = sites.z2pt5
#         else:
#             # Default site and basin model
#             temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
#             temp_z = -1 * np.ones(len(sites.vs30))
#
#         return (self.get_base_term(C) +
#                 self.get_magnitude_scaling_term(C, m_b, rup.mag) +
#                 self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
#                 self.get_shallow_site_response_term(C, temp_vs30, a1100) +
#                 self.get_basin_response_term(C, temp_z, temp_vs30) +
#                 self.get_depth_term(C, rup.ztor) +
#                 self.get_anelastic_attenuation_term(C, dists))
#
#     def get_anelastic_attenuation_term(self, C, dists):
#         """
#         Returns the anelastic attenuation term (Eq. 4.9)
#         Depends on forearc/backarc attenuation
#         Depends on arc crossing path
#         """
#         [c_6xc, c_6_x1, c_6_x2, c_6_x3, c_6_1, c_6_2, c_6_3] = self._get_anelastic_coeff(C)
#         r1 = dists.alpha_backarc * dists.rrup
#         r3 = dists.alpha_nankai * dists.rrup
#         r2 = rrup - r1 - r3
#
#         # NEEDS WORK
#         fx = np.ones(len(r1))
#         fx[dists.alpha_backarc == 0] = 0
#         fx[dists.alpha_backarc == 1] = 0
#         return fx * (c_6xc + c_6_x1 * 1 + c_6_x2 * r2 + c_6_x3 * r3) + (1 - fx) * (c_6_1 * r1 + c_6_2 * r2 + c_6_3 * r3)
#
#     def get_base_term(self, C):
#         """
#         Returns the constant coefficient for Japan
#         """
#         return C["c_1_slab_reg_Ja"]
#
#     def _get_anelastic_coeff(self, C):
#         """
#         Returns the anelastic coefficients for Japan
#         """
#         return C[["c_6xc", "c_6_x1_reg_Ja", "c_6_x2_reg_Ja", "c_6_x3_reg_Ja",\
#                   "c_6_1_reg_Ja", "c_6_2_reg_Ja", "c_6_3_reg_Ja"]]
#
#     def _get_linear_site_coeff(self, C):
#         """
#         Returns the linear site scaling coefficient for Japan
#         """
#         return C["c_7_reg_Ja"]
#
#     def get_basin_response_term(self, C, z_value, vs30):
#         """
#         Returns the basin response term (Eq. 4.10)
#         """
#        if (z_value <= 0):
#            return 0.
#        else:
#            ln_z_ref = self._get_ln_z_ref(vs30)
#            return C["c_11_Ja"] + C["c_12_Ja"] * (np.log(z_value) - ln_z_ref)
#
#     CONSTS = {"c_10": 0.0,
#               "c": 1.88,
#               "n": 1.18,
#               "delta_m": 0.1,
#               "delta_z": 1,
#               "Mref": 6.0,
#               "Zref": 50,
#               "z_b": 80,
#               "m_b": 7.6}
#
#     CONSTS_Z_MODEL = {"c_z_1": 7.689368537500001,
#                       "c_z_2": 2.302585092994046,
#                       "c_z_3": 6.309186400000001,
#                       "c_z_4": 0.7528670225000001}


class KuehnEtAl2020SSlabNewZealand(KuehnEtAl2020SSlab):
    """
    Implements the regional intraslab model for New Zealand
    """

    #: Required site parameters are Vs30, Vs30 type (measured or inferred),
    #: and depth (km) to the 1.0 km/s shear wave velocity layer (z1pt0)
    REQUIRES_SITES_PARAMETERS = {'vs30', 'z1pt0'}

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = sites.z1pt0
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_base_term(self, C):
        """
        Returns the constant coefficient for New Zealand
        """
        return C["c_1_slab_reg_NZ"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for New Zealand
        """
        return C["c_6_2_reg_NZ"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for New Zealand
        """
        return C["c_7_reg_NZ"]

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term (Eq. 4.10)
        """
        mask = (z_value > 0)
        brt = np.zeros_like(z_value)
        brt[mask] = C["c_11_NZ"] + C["c_12_NZ"] * \
                    (np.log(z_value[mask]) - self._get_ln_z_ref(vs30[mask]))
        return brt

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 50,
              "z_b": 80,
              "m_b": 7.6}

    CONSTS_Z_MODEL = {"c_z_1": 6.859789675000001,
                      "c_z_2": 2.302585092994046,
                      "c_z_3": 5.745692775,
                      "c_z_4": 0.91563524375}

# class KuehnEtAl2020SSlabSouthAmerica(KuehnEtAl2020SSlab):
#     """
#     Implements the regional intraslab model for South America
#     """
#
#     #: Required distance measure is Rrup and fraction in backarc
#     REQUIRES_DISTANCES = set(('rrup', 'alpha_backarc'))
#
#     def get_anelastic_attenuation_term(self, C, dists):
#         """
#         Returns the anelastic attenuation term (Eq. 4.9)
#         Depends on forearc/backarc attenuation
#         Depends on arc crossing path
#         alpha is fraction of path in backarc
#         """
#         [c_6xc, c_6_x1, c_6_x2, c_6_1, c_6_2] = self._get_anelastic_coeff(C)
#         r1 = dists.alpha_backarc * dists.rrup
#         r2 = dists.rrup - r1
#
#         fx = np.ones(len(r1))
#         fx[dists.alpha_backarc == 0] = 0
#         fx[dists.alpha_backarc == 1] = 0
#         return fx * (c_6xc + c_6_x1 * 1 + c_6_x2 * r2) + (1 - fx) * (c_6_1 * r1 + c_6_2 * r2)
#
#     def get_base_term(self, C):
#         """
#         Returns the constant coefficient for South America
#         """
#         return C["c_1_slab_reg_SA"]
#
#     def _get_anelastic_coeff(self, C):
#         """
#         Returns the anelastic coefficient for South America
#         """
#         return C[["c_6_x1_reg_SA", "c_6_x2_reg_SA", "c_6_1_reg_SA", "c_6_2_reg_SA"]]
#
#     def _get_linear_site_coeff(self, C):
#         """
#         Returns the linear site scaling coefficient for South America
#         """
#         return C["c_7_reg_SA"]
#
#     CONSTS = {"c_10": 0.0,
#               "c": 1.88,
#               "n": 1.18,
#               "delta_m": 0.1,
#               "delta_z": 1,
#               "Mref": 6.0,
#               "Zref": 50,
#               "z_b": 80,
#               "m_b": 7.3}


class KuehnEtAl2020SSlabTaiwan(KuehnEtAl2020SSlab):
    """
    Implements the regional intraslab model for Taiwan
    """

    #: Required site parameters are Vs30, Vs30 type (measured or inferred),
    #: and depth (km) to the 1.0 km/s shear wave velocity layer (z1p0)
    REQUIRES_SITES_PARAMETERS = {'vs30', 'z1pt0'}

    def get_mean_values(self, C, m_b, sites, rup, dists, a1100):
        """
        Returns the mean values for a specific IMT
        """
        if isinstance(a1100, np.ndarray):
            # Site model defined
            temp_vs30 = sites.vs30
            temp_z = sites.z1pt0
        else:
            # Default site and basin model
            temp_vs30 = 1100.0 * np.ones(len(sites.vs30))
            temp_z = -1 * np.ones(len(sites.vs30))

        return (self.get_base_term(C) +
                self.get_magnitude_scaling_term(C, m_b, rup.mag) +
                self.get_geometric_attenuation_term(C, rup.mag, dists.rrup) +
                self.get_shallow_site_response_term(C, temp_vs30, a1100) +
                self.get_basin_response_term(C, temp_z, temp_vs30) +
                self.get_depth_term(C, rup.ztor) +
                self.get_anelastic_attenuation_term(C, dists))

    def get_base_term(self, C):
        """
        Returns the constant coefficient for Taiwan
        """
        return C["c_1_slab_reg_Tw"]

    def _get_anelastic_coeff(self, C):
        """
        Returns the anelastic coefficient for Taiwan
        """
        return C["c_6_2_reg_Tw"]

    def _get_linear_site_coeff(self, C):
        """
        Returns the linear site scaling coefficient for Taiwan
        """
        return C["c_7_reg_Tw"]

    def get_basin_response_term(self, C, z_value, vs30):
        """
        Returns the basin response term (Eq. 4.10)
        """
        mask = (z_value > 0)
        brt = np.zeros_like(z_value)
        brt[mask] = C["c_11_Tw"] + C["c_12_Tw"] * \
                    (np.log(z_value[mask]) - self._get_ln_z_ref(vs30[mask]))
        return brt

    CONSTS = {"c_10": 0.0,
              "c": 1.88,
              "n": 1.18,
              "delta_m": 0.1,
              "delta_z": 1,
              "Mref": 6.0,
              "Zref": 50,
              "z_b": 80,
              "m_b": 7.7}

    CONSTS_Z_MODEL = {"c_z_1": 6.30560665,
                      "c_z_2": 2.302585092994046,
                      "c_z_3": 6.1104992125,
                      "c_z_4": 0.43671101999999995}
