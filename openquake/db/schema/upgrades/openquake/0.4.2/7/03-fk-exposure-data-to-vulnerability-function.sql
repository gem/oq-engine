/*

    Copyright (c) 2010-2012, GEM Foundation.

    OpenQuake database is made available under the Open Database License:
    http://opendatacommons.org/licenses/odbl/1.0/. Any rights in individual
    contents of the database are licensed under the Database Contents License:
    http://opendatacommons.org/licenses/dbcl/1.0/

*/

ALTER TABLE oqmif.exposure_data
    ADD COLUMN vulnerability_function_id INTEGER NULL;


COMMENT ON COLUMN oqmif.exposure_data.vulnerability_function_id
    IS 'A reference to the vulnerability function that should be used for the asset at hand';


ALTER TABLE oqmif.exposure_data
    ADD CONSTRAINT oqmif_exposure_data_vulnerability_function_fk
        FOREIGN KEY (vulnerability_function_id)
        REFERENCES riski.vulnerability_function(id)
        ON DELETE RESTRICT;


UPDATE oqmif.exposure_data
    SET vulnerability_function_id = vf.id
FROM
    riski.vulnerability_function AS vf
WHERE
    oqmif.exposure_data.vf_ref = vf.vf_ref;


ALTER TABLE oqmif.exposure_data
    ALTER COLUMN vulnerability_function_id SET NOT NULL;


ALTER TABLE oqmif.exposure_data
    DROP COLUMN vf_ref;
