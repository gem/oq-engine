/*

    Copyright (c) 2010-2011, GEM Foundation.

    OpenQuake database is made available under the Open Database License:
    http://opendatacommons.org/licenses/odbl/1.0/. Any rights in individual
    contents of the database are licensed under the Database Contents License:
    http://opendatacommons.org/licenses/dbcl/1.0/

*/

-- Vulnerability function
CREATE TABLE riski.vulnerability_data (
    id SERIAL PRIMARY KEY,
    vulnerability_model_id INTEGER NOT NULL,
    -- The vulnerability function reference is unique within an vulnerability
    -- model.
    vf_ref VARCHAR NOT NULL,
    -- Please note: there must be one loss ratio and coefficient of variation
    -- per IML value defined in the referenced vulnerability model.
    loss_ratios float[] NOT NULL CONSTRAINT loss_ratio_values
        CHECK (0.0 <= ALL(loss_ratios) AND 1.0 >= ALL(loss_ratios)),
    -- Coefficients of variation
    covs float[] NOT NULL,
    last_update timestamp without time zone
        DEFAULT timezone('UTC'::text, now()) NOT NULL,
    UNIQUE (vulnerability_model_id, vf_ref)
) TABLESPACE riski_ts;


ALTER TABLE riski.vulnerability_data ADD CONSTRAINT
riski_vulnerability_data_vulnerability_model_fk FOREIGN KEY
(vulnerability_model_id) REFERENCES riski.vulnerability_model(id) ON DELETE
CASCADE;


CREATE TRIGGER riski_vulnerability_data_refresh_last_update_trig BEFORE UPDATE ON riski.vulnerability_data FOR EACH ROW EXECUTE PROCEDURE refresh_last_update();


GRANT ALL ON SEQUENCE riski.vulnerability_data_id_seq to GROUP openquake;


GRANT SELECT ON riski.vulnerability_data TO GROUP openquake;
GRANT SELECT,INSERT,UPDATE,DELETE ON riski.vulnerability_data TO oq_riski_writer;


COMMENT ON TABLE riski.vulnerability_data IS 'A risk vulnerability function';
COMMENT ON COLUMN riski.vulnerability_data.vulnerability_model_id IS 'A reference to the vulnerability model this function belongs to';
COMMENT ON COLUMN riski.vulnerability_data.vf_ref IS 'The vulnerability function reference, unique within the vulnerability model.';
COMMENT ON COLUMN riski.vulnerability_data.loss_ratios IS 'Loss ratio values, one per IML value in the vulnerability model.';
COMMENT ON COLUMN riski.vulnerability_data.covs IS 'Coefficient of variation values, one per IML value in the vulnerability model.';
COMMENT ON COLUMN riski.vulnerability_data.last_update IS 'Date/time of the last change of the data at hand';
