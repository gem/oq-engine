<?xml version="1.0" encoding="utf-8"?>
<!-- 
    this XSLT style sheet updates NRML instance files of type 
    'vulnerabilityModel' from version 0.1 to version 0.2 
-->
      
<xsl:stylesheet version="1.0" 
                xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                xmlns:xs="http://www.w3.org/2001/XMLSchema"
                xmlns:gml="http://www.opengis.net/gml"
                xmlns:qml="http://quakeml.org/xmlns/quakeml/1.1"
                xmlns:nrml1="http://openquake.org/xmlns/nrml/0.1"
                xmlns:nrml="http://openquake.org/xmlns/nrml/0.2"
                xmlns="http://openquake.org/xmlns/nrml/0.2"
                exclude-result-prefixes="xsl xs nrml1 nrml qml">

    <xsl:include href="nrml_update_common.xsl"/>
    <xsl:output method="xml" indent="yes"/>

    <!-- start main template -->
    <xsl:template match="nrml1:VulnerabilityModel">
        <nrml>
            <xsl:attribute name="gml:id">nrml</xsl:attribute>
            <vulnerabilityModel>
                <xsl:apply-templates select="nrml1:DiscreteVulnerabilitySet"/>
            </vulnerabilityModel>
        </nrml>
    </xsl:template>
    <!-- end main template -->

    <xsl:template match="nrml1:DiscreteVulnerabilitySet">

        <!-- fix asset and loss category in order to match new-style enum values -->
        <xsl:variable name="assetCategory">
            <xsl:call-template name="fix_asset_category">
                <xsl:with-param name="assetCategory" select="@AssetType"/>
            </xsl:call-template>
        </xsl:variable>

        <xsl:variable name="lossCategory">
            <xsl:call-template name="fix_loss_category">
                <xsl:with-param name="lossCategory" select="@LossType"/>
            </xsl:call-template>
        </xsl:variable>

        <discreteVulnerabilitySet>
            <xsl:attribute name="vulnerabilitySetID">
                <xsl:value-of select="@ID"/>
            </xsl:attribute>
            <xsl:attribute name="assetCategory">
                <xsl:value-of select="$assetCategory"/>
            </xsl:attribute>
            <xsl:attribute name="lossCategory">
                <xsl:value-of select="$lossCategory"/>
            </xsl:attribute>

            <xsl:apply-templates select="nrml1:Common/nrml1:IntensityMeasureLevels/nrml1:Values"/>
            <xsl:apply-templates select="nrml1:DiscreteVulnerability"/>
        </discreteVulnerabilitySet>
    </xsl:template>

    <xsl:template match="nrml1:DiscreteVulnerability">
        <discreteVulnerability>
            <xsl:attribute name="vulnerabilityFunctionID">
                <xsl:value-of select="@ID"/>
            </xsl:attribute>
            <xsl:attribute name="probabilisticDistribution">
                <xsl:value-of select="@ProbabilisticDistribution"/>
            </xsl:attribute>
            <lossRatio>
                <xsl:value-of select="./nrml1:LossRatios"/>
            </lossRatio>
            <coefficientsVariation>
                <xsl:value-of select="./nrml1:CoefficientsVariation"/>
            </coefficientsVariation>
        </discreteVulnerability>
    </xsl:template>

    <xsl:template match="nrml1:Common/nrml1:IntensityMeasureLevels/nrml1:Values">
        <IML>
            <xsl:attribute name="IMT">
                <xsl:value-of select="/nrml1:VulnerabilityModel/nrml1:DiscreteVulnerabilitySet/@IntensityMeasureType"/>
            </xsl:attribute>
            <xsl:value-of select="."/>
        </IML>
    </xsl:template>

</xsl:stylesheet>

